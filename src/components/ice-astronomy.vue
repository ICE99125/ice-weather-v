<template>
  <q-card
    flat
    bordered
    class="clickable card-border"
    @click="open = true"
    style="height: 100%"
  >
    <q-card-section class="text-bold">
      {{ $t('weather.astronomy.label') }}
    </q-card-section>

    <q-card-section class="q-pt-none">
      <div
        class="sky"
        :style="{
          backgroundColor: skyColor,
          height: `${skyHeight}px`,
        }"
      >
        <!-- track -->
        <svg>
          <circle
            class="curve-line"
            :stroke="curveLineColor"
            :r="curveRadius"
            cx="50%"
            :cy="skyHeight"
          />
        </svg>

        <!-- sun -->
        <div
          class="sun-orbit"
          :style="{
            transform: `rotate(${sunDeg}deg)`,
            top: `${skyHeight - orbRadius}px`,
            right: '50%',
            width: `${curveRadius + orbRadius}px`,
          }"
        >
          <div class="sun" :style="sphereStyle">
            <div class="sun-light" :style="sphereStyle"></div>
            <div class="sun-light" :style="sphereStyle"></div>
          </div>
        </div>

        <!-- moon -->
        <div
          class="moon-orbit"
          :style="{
            transform: `rotate(${moonDeg}deg)`,
            top: `${skyHeight - orbRadius}px`,
            right: '50%',
            width: `${curveRadius + orbRadius}px`,
          }"
        >
          <div class="moon" :style="sphereStyle"></div>
        </div>
      </div>

      <!-- time -->
      <div class="row justify-between q-pt-md">
        <!-- sunrise & sunset -->
        <div class="row items-center">
          <q-icon name="fa-solid fa-sun" size="25px"></q-icon>
          <div class="q-ml-sm">
            <div>{{ $d(current.sun.sunRise, 'time') }}↑</div>
            <div>{{ $d(current.sun.sunSet, 'time') }}↓</div>
          </div>
        </div>
        <!-- moonrise & moonset -->
        <div class="row items-center">
          <div class="q-mr-sm">
            <div>{{ $d(current.moon.moonRise, 'time') }}↑</div>
            <div>{{ $d(current.moon.moonSet, 'time') }}↓</div>
          </div>
          <q-icon name="fa-solid fa-moon" size="25px"></q-icon>
        </div>
      </div>
    </q-card-section>
  </q-card>
  <ice-astronomy-panel v-model="open"></ice-astronomy-panel>
</template>

<script>
import { defineComponent, ref, watch } from 'vue';
import { useWeatherStore } from '@stores/stores';
import { date } from 'quasar';
import { storeToRefs } from 'pinia';
import iceAstronomyPanel from '@components/ice-astronomy-panel.vue';

const { current } = storeToRefs(useWeatherStore());

export default defineComponent({
  name: 'ice-astronomy',

  components: { iceAstronomyPanel },

  props: {
    visible: {
      type: Boolean,
      default: false,
    },
  },

  setup(props) {
    const sunDeg = ref(0),
      moonDeg = ref(0),
      open = ref(false);

    watch(
      () => props.visible,
      (n) => {
        if (n) {
          setTimeout(() => {
            // one second delay is required here
            // otherwise, the css animate will not work
            // by the way, nextTick has no effect
            const diff1 = date.getDateDiff(
              new Date(),
              current.value.sun.sunRise,
              'seconds'
            );

            const diff2 = date.getDateDiff(
              current.value.sun.sunSet,
              current.value.sun.sunRise,
              'seconds'
            );
            sunDeg.value = 180 * (diff1 / diff2);

            const diff3 = date.getDateDiff(
              new Date(),
              current.value.moon.moonRise,
              'seconds'
            );

            const diff4 = date.getDateDiff(
              current.value.moon.moonSet,
              current.value.moon.moonRise,
              'seconds'
            );

            moonDeg.value = 180 * (diff3 / diff4);
          }, 1000);
        }
      }
    );

    return {
      curveLineColor: ref('#fff'), // the color of curve
      orbRadius: ref(10), // the radius of earth ans moon
      skyHeight: ref(150), // the background color
      sunDeg,
      moonDeg,
      current,
      open,
    };
  },

  computed: {
    sphereStyle() {
      return {
        width: `${this.orbRadius * 2}px`,
        height: `${this.orbRadius * 2}px`,
      };
    },

    skyColor() {
      const diff1 = date.getDateDiff(
        new Date(),
        current.value.sun.sunRise,
        'seconds'
      );

      const diff2 = date.getDateDiff(
        new Date(),
        current.value.sun.sunSet,
        'seconds'
      );

      if (diff1 < 0 || diff2 > 0) {
        // sun is not appeared
        return '#303133';
      } else if (diff2 > -7200) {
        // sunset is still two hours away
        return '#ffcc80';
      } else {
        return '#6AB3FF';
      }
    },

    curveRadius() {
      return this.skyHeight * 0.9 - this.orbRadius * 2;
    },
  },
});
</script>

<style lang="scss" scoped>
$sun-color: #ffcf00;
$sun-light-color: #ffb55a;
$moon-color: #ccc;
$moon-mountain-color: #aaa;

.sky {
  position: relative;
  overflow: hidden;
  transition: 4s background-color ease-out;
  border-radius: 5px;

  & > svg {
    width: 100%;
    height: 100%;
  }

  .sun-orbit,
  .moon-orbit {
    position: absolute;
    height: auto;
    transition: 4s transform ease-out;
    transform-origin: 100% 50%;
  }

  .moon-orbit {
    transition-delay: 0.2s;

    .moon {
      border-radius: 50%;
      background-color: $moon-color;
      position: relative;

      &::after,
      &::before {
        position: absolute;
        content: '';
        border-radius: 50%;
        background-color: $moon-mountain-color;
      }

      &::after {
        top: 20%;
        right: 10%;
        width: 30%;
        height: 30%;
      }

      &::before {
        top: 40%;
        right: 50%;
        width: 15%;
        height: 15%;
      }
    }
  }

  .sun-orbit {
    .sun {
      border-radius: 50%;
      background: $sun-color;

      .sun-light {
        position: absolute;
        background-color: $sun-light-color;
        z-index: -1;

        &:last-of-type {
          transform: rotate(45deg);
        }
      }
    }
  }
}

.curve-line {
  stroke-dasharray: 1, 5;
  stroke-width: 3;
  stroke-linecap: round;
  fill: none;
}
</style>

